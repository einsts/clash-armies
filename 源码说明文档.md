# Clash Armies 项目源码说明文档

## 项目概述

Clash Armies 是一个基于 SvelteKit 框架开发的部落冲突（Clash of Clans）军队构建和管理平台。该项目允许用户创建、分享、评分和评论各种军队配置，支持不同的大本营等级和单位类型。

## 技术架构

### 前端技术栈
- **SvelteKit**: 全栈 Web 应用框架
- **TypeScript**: 类型安全的 JavaScript 超集
- **Svelte 5**: 响应式 UI 框架（使用 `$state` 语法）

### 后端技术栈
- **SvelteKit Server**: 服务端渲染和 API 路由
- **MariaDB/MySQL**: 关系型数据库
- **Lucia**: 身份验证库
- **Zod**: 数据验证库

### 项目结构
```
src/
├── lib/
│   ├── client/          # 客户端工具函数
│   ├── models/          # 数据模型类
│   ├── server/          # 服务端代码
│   │   ├── api/         # API 接口
│   │   ├── auth/        # 认证相关
│   │   └── migration/   # 数据库迁移
│   └── shared/          # 共享代码
├── routes/              # 页面路由
├── components/          # UI 组件
└── static/             # 静态资源
```

## 核心数据结构

### 1. Army（军队）数据结构

**文件位置**: `src/lib/models/Army.svelte.ts`

#### 主要属性
```typescript
export type Army = {
    id: number;                    // 军队唯一标识
    score: number;                 // 评分（基于投票、浏览量等）
    pageViews: number;             // 页面浏览量
    openLinkClicks: number;        // 链接点击次数
    copyLinkClicks: number;        // 复制链接次数
    name: string;                  // 军队名称
    townHall: number;              // 大本营等级
    guide: ArmyGuide | null;       // 使用指南
    units: ArmyUnit[];             // 军队单位
    pets: ArmyPet[];               // 宠物
    equipment: ArmyEquipment[];    // 英雄装备
    banner: Banner;                // 横幅图片
    tags: string[];                // 标签
    comments: ArmyComment[];       // 评论
    username: string;              // 创建者用户名
    createdBy: number;             // 创建者ID
    createdTime: Date;             // 创建时间
    updatedTime: Date;             // 更新时间
    votes: number;                 // 投票数
    userVote: number;              // 当前用户投票
    userBookmarked: boolean;       // 是否被当前用户收藏
};
```

#### 关联实体
- **ArmyUnit**: 军队中的单位（部队、法术、攻城器械）
- **ArmyPet**: 军队中的宠物
- **ArmyEquipment**: 军队中的英雄装备
- **ArmyGuide**: 军队使用指南
- **ArmyComment**: 军队评论

### 2. Unit（单位）数据结构

**文件位置**: `src/lib/shared/types.ts`

```typescript
export type Unit = {
    id: number;                    // 单位ID
    type: UnitType;                // 类型：Troop | Siege | Spell
    name: string;                  // 单位名称
    clashId: number;               // 游戏内ID
    housingSpace: number;          // 占用空间
    productionBuilding: string;    // 生产建筑
    isSuper: boolean;              // 是否为超级单位
    isFlying: boolean;             // 是否为飞行单位
    isJumper: boolean;             // 是否为跳跃单位
    airTargets: boolean;           // 是否攻击空中目标
    groundTargets: boolean;        // 是否攻击地面目标
    levels: UnitLevel[];           // 等级信息
};
```

### 3. TownHall（大本营）数据结构

**文件位置**: `src/lib/shared/types.ts`

```typescript
export type TownHall = {
    level: number;                 // 大本营等级
    maxBarracks: number;           // 最大兵营等级
    maxDarkBarracks: number;       // 最大暗黑兵营等级
    maxLaboratory: number;         // 最大实验室等级
    maxSpellFactory: number;       // 最大法术工厂等级
    maxDarkSpellFactory: number;   // 最大暗黑法术工厂等级
    maxWorkshop: number;           // 最大攻城工坊等级
    maxCc: number;                 // 最大部落城堡等级
    maxBlacksmith: number;         // 最大铁匠铺等级
    maxPetHouse: number;           // 最大宠物小屋等级
    maxBarbarianKing: number;      // 最大野蛮人之王等级
    maxArcherQueen: number;        // 最大弓箭女王等级
    maxGrandWarden: number;        // 最大大守护者等级
    maxRoyalChampion: number;      // 最大皇家冠军等级
    maxMinionPrince: number;       // 最大小王子等级
    troopCapacity: number;         // 部队容量
    spellCapacity: number;         // 法术容量
    siegeCapacity: number;         // 攻城器械容量
    ccLaboratoryCap: number;       // 部落城堡实验室上限
    ccTroopCapacity: number;       // 部落城堡部队容量
    ccSpellCapacity: number;       // 部落城堡法术容量
    ccSiegeCapacity: number;       // 部落城堡攻城器械容量
};
```

### 4. User（用户）数据结构

**文件位置**: `src/lib/shared/types.ts`

```typescript
export type User = {
    id: number;                    // 用户ID
    googleId?: string;             // Google ID（仅自己可见）
    username: string;              // 用户名
    roles: string[];               // 用户角色
    playerTag: string | null;      // 游戏标签
    level: number | null;          // 游戏等级
};
```

## 数据库设计

**数据库架构文件**: `schema.sql`

### 核心表结构

#### 1. armies（军队表）
```sql
CREATE TABLE `armies` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(75) NOT NULL,
  `townHall` smallint(5) unsigned NOT NULL,
  `banner` varchar(255) NOT NULL,
  `createdBy` int(11) NOT NULL,
  `createdTime` timestamp NULL DEFAULT current_timestamp(),
  `updatedTime` timestamp NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id`),
  KEY `fk_armies_created_by` (`createdBy`),
  KEY `fk_armies_town_hall` (`townHall`)
);
```

#### 2. army_units（军队单位表）
```sql
CREATE TABLE `army_units` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `home` varchar(20) NOT NULL DEFAULT 'armyCamp',
  `armyId` int(11) NOT NULL,
  `unitId` int(11) NOT NULL,
  `amount` smallint(5) unsigned NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_army_units_unit_id` (`armyId`,`unitId`,`home`)
);
```

#### 3. army_equipment（军队装备表）
```sql
CREATE TABLE `army_equipment` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `armyId` int(11) NOT NULL,
  `equipmentId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_army_equipment_equipment_id` (`armyId`,`equipmentId`)
);
```

#### 4. army_pets（军队宠物表）
```sql
CREATE TABLE `army_pets` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `hero` varchar(30) NOT NULL,
  `armyId` int(11) NOT NULL,
  `petId` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_army_pets_pet_id` (`armyId`,`petId`,`hero`)
);
```

#### 5. army_votes（军队投票表）
```sql
CREATE TABLE `army_votes` (
  `armyId` int(11) NOT NULL,
  `votedBy` int(11) NOT NULL,
  `vote` tinyint(4) NOT NULL,
  `createdTime` timestamp NULL DEFAULT current_timestamp(),
  `updatedTime` timestamp NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`armyId`,`votedBy`),
  CONSTRAINT `army_votes_vote_value` CHECK (`vote` = -1 or `vote` = 1)
);
```

### 表关系图
```
users (1) ←→ (N) armies
armies (1) ←→ (N) army_units
armies (1) ←→ (N) army_equipment
armies (1) ←→ (N) army_pets
armies (1) ←→ (N) army_comments
armies (1) ←→ (N) army_votes
armies (1) ←→ (N) army_tags
armies (1) ←→ (1) army_guides
units (1) ←→ (N) army_units
equipment (1) ←→ (N) army_equipment
pets (1) ←→ (N) army_pets
```

## API 接口设计

### 1. ArmyAPI 类

**文件位置**: `src/lib/server/api/ArmyAPI.ts`

#### 主要方法

##### getArmies()
```typescript
public async getArmies(req: RequestEvent, options: GetArmiesOptions = {})
```
- **功能**: 获取军队列表
- **参数**: 
  - `ids`: 指定军队ID数组
  - `username`: 指定用户名
  - `sort`: 排序方式（'new' | 'score'）
  - `townHall`: 大本营等级过滤
- **返回**: Army[] 数组

##### saveArmy()
```typescript
public async saveArmy(req: RequestEvent, data: unknown): Promise<number>
```
- **功能**: 保存或更新军队
- **参数**: 军队数据
- **返回**: 军队ID
- **权限**: 需要认证，只能编辑自己的军队或管理员

##### deleteArmy()
```typescript
public async deleteArmy(req: RequestEvent, armyId: number)
```
- **功能**: 删除军队
- **权限**: 只能删除自己的军队或管理员

##### saveComment()
```typescript
public async saveComment(req: RequestEvent, data: unknown)
```
- **功能**: 保存评论
- **支持**: 回复功能，自动通知相关用户

##### saveVote()
```typescript
public async saveVote(req: RequestEvent, options: SaveVoteOptions)
```
- **功能**: 保存投票（-1: 反对, 0: 取消, 1: 赞成）

#### 数据查询优化
- 使用复杂的 SQL JOIN 查询一次性获取军队的所有关联数据
- 通过 JSON_ARRAYAGG 聚合关联数据
- 支持分页和排序

### 2. ArmyMetricsAPI 类

**文件位置**: `src/lib/server/api/ArmyMetricsAPI.ts`

#### 主要功能
- **页面浏览统计**: 防止重复计数的反垃圾机制
- **链接点击统计**: 复制链接和打开链接的统计
- **访客识别**: 基于 Cookie 的访客追踪
- **数据清理**: 定期清理过期的事件数据

#### 反垃圾机制
```typescript
private async handleMetricEvent(req: RequestEvent, armyId: number, metricName: string) {
    // 检查是否为机器人
    if (!this.shouldReportMetric(req)) return;
    
    // 验证访客ID
    const visitorUUID = this.validateVisitorId(req);
    
    // 检查时间间隔限制
    const minAgeMs = this.metricsMinAgeMsOverride ?? metric.minAgeHours * HOUR;
    if (!metricEvent || +now - +metricEvent.lastSeen > minAgeMs) {
        // 记录事件
    }
}
```

### 3. UserAPI 类

**文件位置**: `src/lib/server/api/UserAPI.ts`

#### 主要方法
- **getUsers()**: 获取用户列表
- **getUser()**: 根据用户名获取用户
- **saveUser()**: 保存用户信息
- **权限控制**: 普通用户只能看到自己的 Google ID

### 4. NotificationAPI 类

**文件位置**: `src/lib/server/api/NotificationAPI.ts`

#### 主要功能
- **评论通知**: 当有人评论军队时通知创建者
- **回复通知**: 当有人回复评论时通知原评论者
- **批量确认**: 支持批量标记通知为已读
- **数据清理**: 定期清理过期通知

## 数据模型类

### 1. ArmyModel 类

**文件位置**: `src/lib/models/Army.svelte.ts`

#### 核心功能
```typescript
export class ArmyModel {
    // 响应式状态管理
    public name = $state<string | null>(null);
    public townHall = $state(17);
    public units = $state<UnitModel[]>([]);
    public pets = $state<PetModel[]>([]);
    public equipment = $state<EquipmentModel[]>([]);
    
    // 军队管理方法
    public addUnit(unit: Unit, home: UnitHome, amount = 1): UnitModel
    public addPet(pet: Pet, hero: HeroType): PetModel
    public addEquipment(equipment: Equipment): EquipmentModel
    public remove(name: string, housedIn: UnitHome): void
    
    // 计算属性
    public get capacity(): { troops: number, spells: number, sieges: number }
    public get housingSpaceUsed(): { troops: number, sieges: number, spells: number }
    public get thData(): TownHall
    
    // 军队类型分析
    private getArmyType(): 'Air' | 'Ground' | 'Hybrid'
}
```

#### 军队类型判断逻辑
```typescript
private getArmyType() {
    let airTotal = 0;
    let groundTotal = 0;
    
    for (const unit of this.allUnits) {
        if (unit.info.type === 'Spell') continue;
        const weight = unit.amount * unit.info.housingSpace;
        if (unit.info.isFlying) {
            airTotal += weight;
        } else {
            groundTotal += weight;
        }
    }
    
    const total = airTotal + groundTotal;
    const airRatio = total === 0 ? 0 : airTotal / total;
    
    // 空中或地面部队占比超过60%时判定为对应类型
    if (airRatio > 0.6) return 'Air';
    if (airRatio < 0.4) return 'Ground';
    return 'Hybrid';
}
```

### 2. UnitModel 类

**文件位置**: `src/lib/models/Unit.svelte.ts`

#### 核心功能
```typescript
export class UnitModel {
    // 单位信息
    public info: Unit;
    public amount = $state(1);
    public home: UnitHome;
    
    // 等级计算
    public static getMaxLevel(unit: Unit, townHall: number, gameData: StaticGameData): number
    public static getMaxCcLevel(unit: Unit, townHall: number, gameData: StaticGameData): number
    
    // 容量计算
    public static getTotals(units: UnitModel[]): { troops: number, sieges: number, spells: number }
}
```

#### 等级解锁逻辑
```typescript
public static getMaxLevel(unit: Unit, townHall: number, gameData: StaticGameData): number {
    const thData = ArmyModel.requireTownHall(townHall, gameData);
    
    for (const levelData of unit.levels) {
        const { level } = levelData;
        
        if (type === 'Troop') {
            // 检查兵营等级
            const prodLevel = prod === 'Barrack' ? thData.maxBarracks : thData.maxDarkBarracks;
            if ((levelData.barrackLevel ?? -1) > prodLevel) {
                return maxLevel;
            }
        }
        
        if (type === 'Spell') {
            // 检查法术工厂等级
            if (thData.level < 5) return maxLevel;
            const prodLevel = prod === 'Spell Factory' ? thData.maxSpellFactory : thData.maxDarkSpellFactory;
            if ((levelData.spellFactoryLevel ?? -1) > prodLevel) {
                return maxLevel;
            }
        }
        
        // 检查实验室等级
        const labLevel = thData.maxLaboratory ?? -1;
        if (level !== 1 && (levelData.laboratoryLevel ?? -1) > labLevel) {
            return maxLevel;
        }
        
        maxLevel = level;
    }
    
    return maxLevel;
}
```

## 前端组件架构

### 1. 路由结构

**路由文件位置**: `src/routes/`

```
/                    # 首页 - src/routes/+page.svelte
/armies             # 军队列表 - src/routes/armies/+page.svelte
/armies/[id]        # 军队详情 - src/routes/armies/[id]/+page.svelte
/army-builder       # 军队构建器 - src/routes/army-builder/+page.svelte
/create             # 创建军队 - src/routes/create/+page.svelte
/login              # 登录页面 - src/routes/login/+page.svelte
/admin              # 管理页面 - src/routes/admin/+page.svelte
/users/[username]   # 用户页面 - src/routes/users/[username]/+page.svelte
```

### 2. 核心组件

**组件文件位置**: `src/components/`

#### ArmyBuilder 组件
- **功能**: 军队构建器主界面
- **状态管理**: 使用 Svelte 5 的 `$state` 语法
- **实时验证**: 容量检查、等级限制等

#### ArmyCard 组件
- **功能**: 军队卡片展示
- **交互**: 投票、收藏、分享
- **响应式**: 自适应布局

#### UnitSelector 组件
- **功能**: 单位选择器
- **分类**: 按类型（部队、法术、攻城器械）分组
- **搜索**: 支持名称搜索

## 安全机制

### 1. 身份验证
- 基于 Lucia 的会话管理
- Google OAuth 集成
- 角色权限控制

### 2. 数据验证
- 使用 Zod 进行输入验证
- SQL 注入防护
- XSS 防护（HTML 内容清理）

### 3. 访问控制
```typescript
// 用户只能编辑自己的军队
if (user.id === existing.createdBy) {
    // 允许编辑
} else {
    // 需要管理员权限
    req.locals.requireRoles('admin');
}
```

## 性能优化

### 1. 数据库优化
- 复杂的 JOIN 查询减少数据库往返
- 索引优化（外键、唯一键）
- 连接池管理

### 2. 缓存策略
- 静态游戏数据内存缓存
- 用户会话缓存
- 响应式状态管理

### 3. 前端优化
- 懒加载组件
- 虚拟滚动（大量数据）
- 图片优化（WebP 格式）

## 部署和运维

### 1. 环境配置
- 环境变量管理
- 数据库连接配置
- 静态资源路径配置

### 2. 监控和日志
- 结构化日志记录
- 性能指标收集
- 错误追踪

### 3. 定时任务
```typescript
// 每小时清理过期数据
this.hourlyTaskJob = new CronJob('0 0 * * * *', async () => {
    return this.hourlyTask();
});
```

## 扩展性设计

### 1. 模块化架构
- API 接口模块化
- 数据模型分离
- 组件可复用性

### 2. 配置驱动
- 游戏数据配置化
- 权限角色配置
- 功能开关配置

### 3. 国际化支持
- 多语言文本配置
- 时区处理
- 数字格式化

## 总结

Clash Armies 项目采用了现代化的全栈架构，具有以下特点：

1. **技术先进**: 使用 SvelteKit + TypeScript + MariaDB 技术栈
2. **架构清晰**: 前后端分离，模块化设计
3. **功能完整**: 支持军队创建、分享、评分、评论等完整功能
4. **性能优化**: 数据库查询优化、前端状态管理优化
5. **安全可靠**: 完善的权限控制和数据验证
6. **易于维护**: 清晰的代码结构和文档

该项目为部落冲突玩家提供了一个功能强大、用户体验良好的军队管理平台，具有良好的扩展性和维护性。

## 数据库迁移系统

### 1. 迁移架构

**主迁移文件**: `src/lib/server/migration/index.ts`

项目使用版本化的数据库迁移系统，通过 `@ninjalib/sql` 库管理数据库结构变更。

```typescript
export function migration(runStep: MigrationFn) {
    v0_0_1(runStep);  // 初始版本
    v0_0_2(runStep);  // 功能增强
    v0_1_0(runStep);  // 主要版本更新
    v0_1_1(runStep);  // 补丁版本
    v0_2_0(runStep);  // 架构重构
    v0_3_0(runStep);  // 新功能添加
    v0_4_0(runStep);  // 性能优化
    v0_5_0(runStep);  // 最新版本
}
```

### 2. 迁移示例

**迁移版本文件**: `src/lib/server/migration/v0_5_0.ts`

```typescript
// v0_5_0.ts 迁移示例
runStep(47, `
    ALTER TABLE users
    ADD COLUMN createdTime TIMESTAMP DEFAULT NOW()
`);

runStep(48, `
    CREATE TABLE army_tags (
        armyId INT NOT NULL,
        tag VARCHAR(50) NOT NULL,
        PRIMARY KEY (armyId, tag),
        CONSTRAINT fk_army_tags_army_id FOREIGN KEY (armyId) REFERENCES armies (id) ON DELETE CASCADE
    )
`);

// 数据插入迁移
runStep(49, async (db: MySQL) => {
    const equipmentId = await db.insertOne('equipment', {
        hero: 'Minion Prince',
        name: 'Dark Crown',
        epic: 1,
        clashId: 35,
    });
    // 插入等级数据...
});
```

### 3. 迁移最佳实践
- 每个迁移步骤都有唯一的数字标识
- 支持结构变更和数据插入
- 使用事务确保数据一致性
- 向后兼容性考虑

## 数据验证系统

### 1. Zod 验证模式

**验证文件**: `src/lib/shared/validation.ts`

项目使用 Zod 库进行全面的数据验证，确保数据完整性和安全性。

```typescript
// 基础验证模式
export const numberSchema = z.number().int().positive();
export const unitSchema = z.object({
    id: numberSchema.optional(),
    unitId: numberSchema,
    home: z.enum(VALID_UNIT_HOME),
    amount: numberSchema,
});

// 军队验证模式
export const armySchema = z.object({
    id: numberSchema.optional(),
    name: z.string().min(2).max(25),
    townHall: numberSchema,
    banner: z.enum(BANNERS),
    units: z.array(unitSchema).nonempty(),
    equipment: z.array(equipmentSchema),
    pets: z.array(petSchema),
    tags: z.array(z.enum(ARMY_TAGS)).max(MAX_ARMY_TAGS),
    guide: guideSchema.nullable(),
});
```

### 2. 业务逻辑验证
```typescript
export function validateArmy(data: unknown, gameData: StaticGameData): ArmyModel {
    const army = armySchema.parse(data);
    const model = new ArmyModel(gameData, army);

    // 英雄数量限制
    const heroesUsed = VALID_HEROES.filter((hero) => hasHero(hero, model)).length;
    if (heroesUsed > 4) {
        throw new Error('Cannot use more than 4 heroes');
    }

    // 验证各个组件
    validateUnits(model);
    validateCcUnits(model);
    validateEquipment(model);
    validatePets(model);
    if (model.guide) {
        validateGuide(model.guide);
    }

    return model;
}
```

### 3. 验证规则
- **单位重复检查**: 防止同一军队中重复添加相同单位
- **容量限制**: 确保不超过大本营的部队、法术、攻城器械容量
- **等级解锁**: 验证单位等级是否符合大本营和建筑等级要求
- **超级部队限制**: 最多2个不同的超级部队
- **英雄数量限制**: 最多4个英雄

## 认证和授权系统

### 1. Lucia 认证框架

**认证配置文件**: `src/lib/server/auth/lucia.ts`

项目使用 Lucia 作为认证框架，支持 Google OAuth 登录。

```typescript
export const lucia = new Lucia(adapter, {
    sessionCookie: {
        attributes: {
            secure: !dev,  // 生产环境使用 HTTPS
        },
    },
    getUserAttributes: (attributes) => {
        return {
            username: attributes.username,
            playerTag: attributes.playerTag,
            roles: attributes.roles,
        };
    },
});

// Google OAuth 配置
export const google = new Google(
    GOOGLE_AUTH_CLIENT_ID, 
    GOOGLE_AUTH_SECRET, 
    `${BASE_APP_URL}/api/login/google/callback`
);
```

### 2. 自定义数据库适配器

**适配器文件**: `src/lib/server/auth/adapter.ts`

```typescript
export class sqlAdapter {
    // 会话管理
    public async setSession(session: DatabaseSession)
    public async deleteSession(sessionId: string)
    public async deleteExpiredSessions()
    
    // 用户管理
    public async getSessionAndUser(sessionId: string)
    public async deleteUserSessions(userId: UserId)
}
```

### 3. 权限控制
```typescript
// 角色检查
req.locals.hasRoles('admin')
req.locals.requireRoles('admin')

// 资源所有权检查
if (user.id === existing.createdBy) {
    // 允许编辑自己的军队
} else {
    // 需要管理员权限
    req.locals.requireRoles('admin');
}
```

## 工具函数和常量

### 1. 游戏相关常量

**工具文件**: `src/lib/shared/utils.ts`
```typescript
// 超级部队映射
export const SUPER_TO_REGULAR: Record<string, string> = {
    'Super Barbarian': 'Barbarian',
    'Super Archer': 'Archer',
    'Sneaky Goblin': 'Goblin',
    'Rocket Balloon': 'Balloon',
    // ... 更多映射
};

// 横幅图片列表
export const BANNERS = [
    'fire-and-ice', 'samurai', 'dark-days', 'bridge',
    'fire-warden', 'gold-statues', 'goblin-fight',
    // ... 更多横幅
] as const;

// 军队标签
export const ARMY_TAGS = [
    'CWL/War', 'Legends League', 'Farming', 
    'Beginner Friendly', 'Spam'
] as const;
```

### 2. 系统限制常量
```typescript
export const USER_MAX_ARMIES = 40;           // 用户最大军队数量
export const GUIDE_TEXT_CHAR_LIMIT = 3_000;  // 指南文本长度限制
export const MAX_COMMENT_LENGTH = 2_000;      // 评论长度限制
export const MAX_ARMY_TAGS = 3;               // 军队标签数量限制
export const VALID_UNIT_HOME = ['armyCamp', 'clanCastle'] as const;
export const VALID_HEROES = [
    'Barbarian King', 'Archer Queen', 'Grand Warden', 
    'Royal Champion', 'Minion Prince'
] as const;
```

### 3. 时间常量
```typescript
export const SECOND = 1000;
export const MINUTE = SECOND * 60;
export const HOUR = MINUTE * 60;
export const DAY = HOUR * 24;
export const YEAR = DAY * 365;
```

## 错误处理和日志系统

### 1. API 错误处理

**工具文件**: `src/lib/server/utils.ts`

```typescript
export function endpoint(action: (req: RequestEvent) => Promise<Response>) {
    return async (req: RequestEvent) => {
        const server = req.locals.server;
        
        try {
            const result = await action(req);
            return result;
        } catch (err) {
            let errors: APIErrors;
            if (err instanceof z.ZodError) {
                errors = getDisplayZodError(err);
            } else if (err instanceof Error) {
                errors = err.message;
            } else {
                errors = 'Internal server error';
            }

            server.log.error('API error:', {
                requestId: req.locals.uuid,
                error: err,
            });

            return json({ errors }, { status: 400 });
        }
    };
}
```

### 2. 请求统计和日志
```typescript
export type RequestStats = {
    uuid: string;           // 请求唯一标识
    method: string;         // HTTP 方法
    url: string;            // 请求URL
    userId: number | undefined;  // 用户ID
    username: string | undefined; // 用户名
    ip: string;             // 客户端IP
    userAgent: string | null;    // 用户代理
};

export function getRequestStats(req: RequestEvent): RequestStats {
    const { request, locals } = req;
    const { user, uuid } = locals;
    return {
        uuid,
        method: request.method,
        url: request.url,
        userId: user?.id,
        username: user?.username,
        ip: req.getClientAddress(),
        userAgent: request.headers.get('User-Agent'),
    };
}
```

### 3. 结构化日志
```typescript
// 使用 @ninjalib/util 的日志系统
this.log = util.logger('clash-armies:server');
this.log.info('Request:', requestInfo);
this.log.error('API error:', { requestId: req.locals.uuid, error: err });
this.log.warn('Invalid visitor cookie signature:', { requestId: req.locals.uuid });
```

## 环境配置和部署

### 1. 环境变量配置

**数据库配置文件**: `src/lib/server/db.ts`
```typescript
// 数据库配置
const { DB_USER, DB_PASSWORD, DB_PORT } = env;

// Google OAuth 配置
const { GOOGLE_AUTH_CLIENT_ID, GOOGLE_AUTH_SECRET, BASE_APP_URL } = env;

// 访客ID 密钥
const { VISITOR_ID_SECRET } = env;

// 环境检查
if (typeof DB_USER !== 'string') {
    throw new Error('Expected database user to be defined');
}
```

### 2. 数据库连接配置
```typescript
export const db = new MySQL({
    user: DB_USER,
    password: DB_PASSWORD,
    port: +DB_PORT,
    database: 'clash-armies',
    typeCast: function (field, next) {
        // 自定义类型转换，处理 TINYINT(1) 为 boolean
        if (field.type === 'TINY' && field.length === 1) {
            const str = field.string();
            if (str === '0') return false;
            if (str === '1') return true;
            return +str;
        }
        return next();
    },
    timezone: 'Z',  // UTC 时区
});
```

### 3. 开发和生产环境差异
```typescript
// 安全配置
sessionCookie: {
    attributes: {
        secure: !dev,  // 开发环境不使用 HTTPS
    },
},

// 静态资源路径
export const STATIC_BASE_PATH = dev ? 'static' : 'client';

// 基础URL检查
if (!building && !dev && typeof BASE_APP_URL !== 'string') {
    throw new Error('Expected base app url to be defined in production');
}
```

## 性能优化策略

### 1. 数据库查询优化
- **复杂 JOIN 查询**: 一次性获取军队的所有关联数据
- **JSON 聚合**: 使用 `JSON_ARRAYAGG` 减少数据库往返
- **索引优化**: 外键和唯一键索引
- **连接池管理**: 复用数据库连接

### 2. 内存缓存策略
```typescript
// 静态游戏数据缓存
public get gameData(): StaticGameData {
    const { units, equipment, pets, townHalls } = this;
    return { units, equipment, pets, townHalls };
}

// 用户会话缓存
// 响应式状态管理
```

### 3. 前端性能优化
- **懒加载**: 按需加载组件和资源
- **虚拟滚动**: 处理大量数据列表
- **图片优化**: WebP 格式和响应式图片
- **状态管理**: Svelte 5 的 `$state` 响应式系统

## 测试和调试

### 1. 测试工具

**测试文件位置**: `tests/`

```typescript
// 测试工具函数
export function testutil() {
    // 测试辅助函数
}

// 测试数据
export const testData = {
    // 测试用的军队数据
};
```

### 2. 调试支持
```typescript
// 开发环境日志
if (dev) {
    console.log('Development mode');
}

// 请求追踪
req.locals.uuid = uuidv4();  // 每个请求唯一标识
```

## 国际化支持准备

### 1. 文本配置化
- 游戏单位名称可配置
- 错误消息可本地化
- 界面文本支持多语言

### 2. 时区和数字格式
```typescript
// UTC 时区处理
timezone: 'Z',

// 数字格式化支持
export function pluralize(string: string, count: number, suffix = 's') {
    return `${string}${count !== 1 ? suffix : ''}`;
}
```

## 重构指南

### 1. 代码组织原则
- **模块化**: 每个功能模块独立
- **单一职责**: 每个类和方法职责明确
- **依赖注入**: 通过构造函数注入依赖
- **接口分离**: 定义清晰的接口边界

### 2. 数据层重构
- **ORM 迁移**: 考虑使用 Prisma 或 TypeORM
- **查询优化**: 使用查询构建器
- **事务管理**: 统一事务处理逻辑
- **缓存策略**: Redis 缓存热点数据

### 3. API 层重构
- **RESTful 设计**: 标准化 API 接口
- **版本控制**: API 版本管理
- **文档生成**: OpenAPI/Swagger 文档
- **限流和熔断**: 保护系统稳定性

### 4. 前端重构
- **组件库**: 建立统一的 UI 组件库
- **状态管理**: 考虑使用 Svelte stores
- **路由管理**: 优化路由结构和权限
- **性能监控**: 添加性能指标收集

### 5. 部署和运维重构
- **容器化**: Docker 容器部署
- **CI/CD**: 自动化部署流程
- **监控告警**: 系统监控和告警
- **备份恢复**: 数据备份策略

## 总结

这份文档为 Clash Armies 项目提供了全面的技术参考，涵盖了：

1. **完整的技术架构**: 从数据库设计到前端组件
2. **详细的代码结构**: 每个模块的功能和实现
3. **最佳实践指南**: 安全、性能、可维护性
4. **重构参考**: 为未来的代码重构提供指导

该文档可以作为：
- 新团队成员的入门指南
- 代码重构时的技术参考
- 系统维护和扩展的依据
- 技术决策的参考文档

通过这份文档，开发者可以快速理解项目架构，掌握核心功能实现，并为未来的功能扩展和系统优化提供可靠的技术基础。
