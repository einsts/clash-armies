# ğŸš€ Clash Armies APPæ¥å£è®¾è®¡æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡
ä¸ºClash Armiesé¡¹ç›®å¼€å‘ç§»åŠ¨ç«¯APPæ¥å£ï¼Œæœ€å¤§åŒ–å¤ç”¨ç°æœ‰Webå‰ç«¯åŠŸèƒ½ï¼ŒåŒ…æ‹¬å†›é˜Ÿå±•ç¤ºã€åˆ›å»ºã€è¯„è®ºã€ç‚¹èµä»¥åŠç”¨æˆ·ç™»å½•/æ³¨å†Œç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### æ ¸å¿ƒåŸåˆ™
- **æœ€å¤§åŒ–ä»£ç å¤ç”¨** - 95%+çš„ä¸šåŠ¡é€»è¾‘å¤ç”¨ç°æœ‰ä»£ç 
- **é›¶é‡å¤å®ç°** - é¿å…åŠŸèƒ½å·®å¼‚å’Œç»´æŠ¤å›°éš¾
- **å¿«é€Ÿå¼€å‘** - åŸºäºç°æœ‰åŠŸèƒ½å¿«é€Ÿæ„å»ºAPPæ¥å£
- **è´¨é‡ä¿è¯** - å¤ç”¨ç»è¿‡æµ‹è¯•çš„ç°æœ‰ä»£ç 

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    APPå®¢æˆ·ç«¯     â”‚    â”‚   APPæ¥å£å±‚      â”‚    â”‚   ç°æœ‰åç«¯       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚  - å†›é˜Ÿå±•ç¤º -    â”‚â—„â”€â”€â–ºâ”‚  - æ•°æ®è½¬æ¢ -     â”‚â—„â”€â”€â–ºâ”‚  - ArmyAPI -    â”‚
â”‚  - ç”¨æˆ·è®¤è¯ -    â”‚    â”‚  - JWTè®¤è¯ -     â”‚    â”‚  - UserAPI -    â”‚
â”‚  - äº¤äº’åŠŸèƒ½ -    â”‚    â”‚  - ä¸­é—´ä»¶ -      â”‚    â”‚  - æ•°æ®åº“ -      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ç‰¹ç‚¹
1. **APPæ¥å£é€‚é…å±‚** - åœ¨ç°æœ‰åç«¯ä¹‹ä¸Šæ„å»º
2. **ç»Ÿä¸€ä¸­é—´ä»¶ç³»ç»Ÿ** - è®¤è¯ã€é™æµã€é”™è¯¯å¤„ç†ã€CORS
3. **æ ‡å‡†åŒ–å“åº”æ ¼å¼** - ä¸€è‡´çš„æ¥å£è§„èŒƒå’Œå“åº”æ ¼å¼
4. **ç±»å‹å®‰å…¨** - å®Œæ•´çš„TypeScriptç±»å‹ç³»ç»Ÿ

## ğŸ“ é¡¹ç›®ç»“æ„

### ç›®å½•ç»„ç»‡ï¼ˆä»…å±•ç¤ºä¸ºappæä¾›æ¥å£çš„ç›®å½•ï¼‰
```
src/
â”œâ”€â”€ lib/app/                    # APPæ¥å£é€‚é…å±‚
â”‚   â”œâ”€â”€ api/                    # APP APIé€‚é…ç±»
â”‚   â”œâ”€â”€ middleware/             # APPä¸“ç”¨ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ transformers/           # æ•°æ®è½¬æ¢å™¨
â”‚   â”œâ”€â”€ types/                  # APPä¸“ç”¨ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ utils/                  # APPå·¥å…·å‡½æ•°
â”œâ”€â”€ routes/app/                 # APPä¸“ç”¨è·¯ç”±
â”‚   â”œâ”€â”€ health/                 # å¥åº·æ£€æŸ¥
â”‚   â””â”€â”€ api/v1/                 # APP API v1
â”‚       â”œâ”€â”€ auth/               # ç”¨æˆ·è®¤è¯
â”‚       â”œâ”€â”€ armies/             # å†›é˜Ÿç®¡ç†
â”‚       â””â”€â”€ game/               # æ¸¸æˆæ•°æ®
â”‚       â””â”€â”€ users/              # ç”¨æˆ·é…ç½®
â””â”€â”€ tests/app/                  # APPä¸“ç”¨æµ‹è¯•
```

### æ ¸å¿ƒæ¨¡å—
- **ä¸­é—´ä»¶ç³»ç»Ÿ** - JWTè®¤è¯ã€é™æµã€é”™è¯¯å¤„ç†ã€CORS
- **æ•°æ®è½¬æ¢å™¨** - å°†ç°æœ‰æ•°æ®æ ¼å¼è½¬æ¢ä¸ºAPPæ ¼å¼
- **ç±»å‹ç³»ç»Ÿ** - å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- **å·¥å…·å‡½æ•°** - æ ‡å‡†åŒ–çš„å“åº”åˆ›å»ºå’Œé”™è¯¯å¤„ç†

## ğŸ”Œ æ¥å£è®¾è®¡

### 1. å¥åº·æ£€æŸ¥æ¥å£
```
GET /app/health
å“åº”: æœåŠ¡çŠ¶æ€ã€ç‰ˆæœ¬ä¿¡æ¯ã€ç¯å¢ƒä¿¡æ¯
```

### 2. ç”¨æˆ·è®¤è¯æ¥å£
```
POST /app/api/v1/auth/login      # ç”¨æˆ·ç™»å½•ï¼ˆGoogle ID Tokenï¼‰
POST /app/api/v1/auth/refresh    # Tokenåˆ·æ–°
POST /app/api/v1/auth/logout     # ç”¨æˆ·ç™»å‡º
```

### 3. ç”¨æˆ·åå¥½è®¾ç½®æ¥å£
```
GET /app/api/v1/users/profile    # è·å–ç”¨æˆ·èµ„æ–™
PUT /app/api/v1/users/profile    # æ›´æ–°ç”¨æˆ·èµ„æ–™ï¼ˆç”¨æˆ·åï¼‰
```

### 4. å†›é˜Ÿç®¡ç†æ¥å£
```
GET    /app/api/v1/armies        # å†›é˜Ÿåˆ—è¡¨
POST   /app/api/v1/armies        # åˆ›å»ºå†›é˜Ÿ
GET    /app/api/v1/armies/[id]   # å†›é˜Ÿè¯¦æƒ…
PUT    /app/api/v1/armies/[id]   # æ›´æ–°å†›é˜Ÿ
DELETE /app/api/v1/armies/[id]   # åˆ é™¤å†›é˜Ÿ
```

### 5. å†›é˜Ÿäº¤äº’æ¥å£
```
POST   /app/api/v1/armies/[id]/like      # ç‚¹èµå†›é˜Ÿ (vote: 1)
DELETE /app/api/v1/armies/[id]/like      # å–æ¶ˆç‚¹èµ (vote: 0)
POST   /app/api/v1/armies/[id]/dislike   # åå‘ç‚¹èµ (vote: -1)
DELETE /app/api/v1/armies/[id]/dislike   # å–æ¶ˆåå‘ç‚¹èµ (vote: 0)
POST   /app/api/v1/armies/[id]/bookmark  # æ”¶è—å†›é˜Ÿ
DELETE /app/api/v1/armies/[id]/bookmark  # å–æ¶ˆæ”¶è—
GET    /app/api/v1/armies/bookmarked     # è·å–æ”¶è—å†›é˜Ÿåˆ—è¡¨
```

### 6. è¯„è®ºç³»ç»Ÿæ¥å£
```
GET  /app/api/v1/armies/[id]/comments    # è·å–è¯„è®º
POST /app/api/v1/armies/[id]/comments    # å‘è¡¨è¯„è®º
DELETE /app/api/v1/armies/[id]/comments?commentId=X  # åˆ é™¤è¯„è®º
```

### 7. æ¸¸æˆæ•°æ®æ¥å£
```
GET /app/api/v1/game/units       # å•ä½æ•°æ®
GET /app/api/v1/game/equipment   # è£…å¤‡æ•°æ®
GET /app/api/v1/game/pets        # å® ç‰©æ•°æ®
GET /app/api/v1/game/townhalls   # å¤§æœ¬è¥æ•°æ®
```

## ğŸ” è®¤è¯ä¸å®‰å…¨

### è®¤è¯ç³»ç»Ÿåˆ†ç¦»
APPæ¥å£å’ŒWebæ¥å£ä½¿ç”¨å®Œå…¨ç‹¬ç«‹çš„è®¤è¯ç³»ç»Ÿï¼š
- **APPæ¥å£**: ä½¿ç”¨JWT Tokenè®¤è¯ï¼Œä¸ä¾èµ–Webç«¯OAuthæµç¨‹
- **Webæ¥å£**: ä½¿ç”¨Lucia + Google OAuthè®¤è¯
- **è·¯ç”±éš”ç¦»**: `/app/*` è·¯ç”±è·³è¿‡Webç«¯è®¤è¯ï¼Œä½¿ç”¨APP JWTè®¤è¯

### JWT Tokenç»“æ„
```typescript
interface AccessTokenPayload {
  userId: number;
  username: string;
  roles: string[];
  iat: number;
  exp: number;
}

interface RefreshTokenPayload {
  userId: number;
  version: number;
  iat: number;
  exp: number;
}
```

### APPè®¤è¯æµç¨‹
1. ç”¨æˆ·é€šè¿‡APPç™»å½•è·å–Access Tokenå’ŒRefresh Token
2. åç»­è¯·æ±‚åœ¨Headerä¸­æºå¸¦ `Authorization: Bearer <token>`
3. Tokenè¿‡æœŸæ—¶ä½¿ç”¨Refresh Tokenè·å–æ–°çš„Tokenå¯¹
4. æ”¯æŒè®¾å¤‡ç®¡ç†å’ŒTokenç‰ˆæœ¬æ§åˆ¶
5. **å®Œå…¨ç‹¬ç«‹**: ä¸ä¼šé‡å®šå‘åˆ°Webç«¯OAuthæµç¨‹

### å®‰å…¨ç‰¹æ€§
- **é™æµä¿æŠ¤** - åŸºäºIPå’Œç”¨æˆ·çš„è¯·æ±‚é™åˆ¶
- **è¾“å…¥éªŒè¯** - Zod schemaéªŒè¯æ‰€æœ‰è¾“å…¥
- **é”™è¯¯å¤„ç†** - æ ‡å‡†åŒ–çš„é”™è¯¯ç å’Œæ¶ˆæ¯
- **CORSæ”¯æŒ** - è·¨åŸŸè¯·æ±‚å¤„ç†

## ğŸ“Š æ•°æ®è½¬æ¢è®¾è®¡

### è½¬æ¢å™¨æ¶æ„
```typescript
abstract class BaseTransformer<T, R> {
  abstract toAppFormat(data: T, gameData?: any): R;
  abstract toAppFormatList(dataList: T[], gameData?: any): R[];
  
  protected formatDate(date: Date): string;
  protected formatNumber(num: number): number;
  protected getOrDefault<V>(current: V, defaultValue: V): V;
}
```

### ä¸»è¦è½¬æ¢å™¨
- **ArmyTransformer** - å†›é˜Ÿæ•°æ®è½¬æ¢
- **UserTransformer** - ç”¨æˆ·æ•°æ®è½¬æ¢
- **å¯æ‰©å±•è®¾è®¡** - æ”¯æŒæ·»åŠ æ–°çš„è½¬æ¢å™¨

## ğŸ§ª æµ‹è¯•è¦†ç›–

APPæ¥å£æµ‹è¯•ç°åœ¨å·²ä½¿ç”¨postmanæµ‹è¯•ï¼Œ
postmanæµ‹è¯•é…ç½®æ–‡ä»¶ä½äºtest/postmanç›®å½•


## ğŸ› ï¸ å¼€å‘ç¯å¢ƒ

### ç¯å¢ƒè¦æ±‚
- **Node.js**: 23.3.0+
- **æ•°æ®åº“**: MariaDB(Docker)
- **è®¤è¯**: Lucia + Google OAuth
- **ä¾èµ–**: JWTã€Zodã€UUIDç­‰

### æœ¬åœ°å¼€å‘
```bash
# å¯åŠ¨æ•°æ®åº“
docker-compose up -d db

# å¯åŠ¨åº”ç”¨
npm run start

```

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯æ–‡æ¡£
- [æºç è¯´æ˜æ–‡æ¡£.md](./æºç è¯´æ˜æ–‡æ¡£.md) - åŸWebé¡¹ç›®æ•´ä½“æ¶æ„å’Œä»£ç è¯´æ˜
- [SvelteKitå®˜æ–¹æ–‡æ¡£](https://kit.svelte.dev/) - æ¡†æ¶ä½¿ç”¨æŒ‡å—
- [Luciaè®¤è¯æ–‡æ¡£](https://lucia-auth.com/) - è®¤è¯ç³»ç»Ÿè¯´æ˜

### å¼€å‘æŒ‡å—
- [APP-APIæ¥å£è§„èŒƒ](./APP-APIæ¥å£è§„èŒƒ.md) - å®Œæ•´çš„APIæ¥å£å‚è€ƒæ–‡æ¡£
